name: tfpipeline

on:
  pull_request:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Install in-toto + sigstore
        run: |
          python -m pip install --upgrade pip
          pip install in-toto sigstore

      # CI functionary key (private) stored in GitHub Secret as base64
      - name: Load in-toto CI key
        run: |
          mkdir -p in-toto/ci-keys
          echo "${{ secrets.IN_TOTO_CI_KEY_B64 }}" | base64 -d > in-toto/ci-keys/ci-functionary
          chmod 600 in-toto/ci-keys/ci-functionary

      # ---------- in-toto evidence ----------
      - name: Terraform Init (in-toto)
        working-directory: terra
        run: |
          in-toto-run \
            --step-name terraform-init \
            --signing-key ../in-toto/ci-keys/ci-functionary \
            --materials . \
            --products .terraform .terraform.lock.hcl \
            -- terraform init -input=false

      - name: Terraform Plan (in-toto)
        working-directory: terra
        run: |
          in-toto-run \
            --step-name terraform-plan \
            --signing-key ../in-toto/ci-keys/ci-functionary \
            --materials . \
            --products tfplan.binary \
            -- terraform plan -out=tfplan.binary -input=false

      # ---------- Sigstore sign + verify ----------
      - name: Sigstore Sign (and record in-toto)
        run: |
          in-toto-run \
            --step-name sigstore-sign \
            --signing-key in-toto/ci-keys/ci-functionary \
            --materials terra/tfplan.binary \
            --products terra/tfplan.binary.sigstore.json \
            -- sigstore sign terra/tfplan.binary >/dev/null

      - name: Sigstore Verify Identity
        run: |
          sigstore verify identity terra/tfplan.binary \
            --bundle terra/tfplan.binary.sigstore.json \
            --cert-identity "https://github.com/MoulikMahajan2004/SLSA/.github/workflows/slsapipeline.yaml@refs/heads/main" \
            --oidc-issuer "https://token.actions.githubusercontent.com" \
            | tee terra/sigstore_verify.txt

      - name: Record sigstore-verify (in-toto)
        run: |
          in-toto-run \
            --step-name sigstore-verify \
            --signing-key in-toto/ci-keys/ci-functionary \
            --materials terra/tfplan.binary terra/tfplan.binary.sigstore.json \
            --products terra/sigstore_verify.txt \
            -- bash -lc "true"

      # ---------- OPA ----------
      - name: Create JSON plan
        working-directory: terra
        run: terraform show -json tfplan.binary > terraformplan.json

      - name: OPA policy check (and record in-toto)
        working-directory: terra
        run: |
          opa eval -i terraformplan.json -d tf.rego 'data.pipeline' | tee opa_result.txt
          in-toto-run \
            --step-name opa-policy \
            --signing-key ../in-toto/ci-keys/ci-functionary \
            --materials terraformplan.json tf.rego tfplan.binary \
            --products opa_result.txt \
            -- bash -lc "true"

      # ---------- Verify full chain ----------
      - name: in-toto verify
        run: |
          ls -la *.link || true
          in-toto-verify -l in-toto/root.layout -v

      - name: Upload in-toto links
        uses: actions/upload-artifact@v4
        with:
          name: in-toto-links
          path: "*.link"

  apply:
    needs: plan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terra
        run: terraform init

      - name: Terraform Apply (use exact plan)
        working-directory: terra
        run: terraform apply -auto-approve tfplan.binary
